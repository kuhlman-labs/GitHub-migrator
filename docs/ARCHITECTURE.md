# Backend Architecture

This document provides an overview of the GitHub Migrator backend architecture.

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    CLIENTS                                          │
│                         (Web UI, CLI, External Systems)                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              API LAYER (internal/api)                               │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                           HTTP Server & Router                                 │  │
│  │                              (server.go)                                       │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐ │
│  │  Middleware │  │    Auth     │  │   Logging   │  │        Rate Limiting        │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────────┘ │
│                                        │                                            │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                        HANDLERS (internal/api/handlers)                        │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │  │
│  │  │ Repository   │ │    Batch     │ │  Analytics   │ │      Migration       │   │  │
│  │  │   Handler    │ │   Handler    │ │   Handler    │ │      Handlers        │   │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────────────┘   │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │  │
│  │  │   Discovery  │ │     Team     │ │     User     │ │     ADO Handlers     │   │  │
│  │  │   Handlers   │ │   Handlers   │ │   Handlers   │ │                      │   │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────────────┘   │  │
│  │                              │                                                  │  │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    HandlerUtils (Shared Utilities)                        │ │  │
│  │  │            CheckRepositoryAccess(), GetClientForOrg()                     │ │  │
│  │  └───────────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          SERVICE LAYER (internal/services)                          │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────────────┐   │
│  │       RepositoryService         │  │            BatchService                 │   │
│  │  - GetRepositoryWithDetails()   │  │  - GetBatchWithStats()                  │   │
│  │  - MarkAsWontMigrate()          │  │  - AddRepositoriesToBatch()             │   │
│  │  - CheckBatchEligibility()      │  │  - DryRunBatch()                        │   │
│  │  - RediscoverRepository()       │  │  - StartBatch()                         │   │
│  └─────────────────────────────────┘  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            ▼                           ▼                           ▼
┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────────────────┐
│   DISCOVERY LAYER     │  │   MIGRATION LAYER     │  │       BATCH LAYER             │
│ (internal/discovery)  │  │  (internal/migration) │  │     (internal/batch)          │
│                       │  │                       │  │                               │
│ ┌───────────────────┐ │  │ ┌───────────────────┐ │  │ ┌─────────────────────────┐   │
│ │    Collector      │ │  │ │     Executor      │ │  │ │     Orchestrator        │   │
│ │  - Orchestrates   │ │  │ │  - Multi-phase    │ │  │ │  - Batch coordination   │   │
│ │    discovery      │ │  │ │    migration      │ │  │ └─────────────────────────┘   │
│ └───────────────────┘ │  │ │  - Polling        │ │  │ ┌─────────────────────────┐   │
│ ┌───────────────────┐ │  │ │  - Validation     │ │  │ │      Scheduler          │   │
│ │  RepoDiscoverer   │ │  │ └───────────────────┘ │  │ │  - Priority queuing     │   │
│ │  - List repos     │ │  │ ┌───────────────────┐ │  │ └─────────────────────────┘   │
│ │  - Filter/Stats   │ │  │ │    Strategies     │ │  │ ┌─────────────────────────┐   │
│ └───────────────────┘ │  │ │  - GitHub         │ │  │ │     Organizer           │   │
│ ┌───────────────────┐ │  │ │  - ADO            │ │  │ │  - Batch grouping       │   │
│ │  TeamDiscoverer   │ │  │ └───────────────────┘ │  │ └─────────────────────────┘   │
│ │  - Teams & roles  │ │  │ ┌───────────────────┐ │  └───────────────────────────────┘
│ └───────────────────┘ │  │ │  TeamExecutor     │ │
│ ┌───────────────────┐ │  │ │  - Team migration │ │
│ │ MemberDiscoverer  │ │  │ └───────────────────┘ │
│ │  - Org members    │ │  └───────────────────────┘
│ └───────────────────┘ │
│ ┌───────────────────┐ │
│ │     Profiler      │ │
│ │  - Repo analysis  │ │
│ │  - Complexity     │ │
│ └───────────────────┘ │
│ ┌───────────────────┐ │
│ │ DependencyAnalyzer│ │
│ │  - Package deps   │ │
│ └───────────────────┘ │
└───────────────────────┘
            │                           │                           │
            └───────────────────────────┼───────────────────────────┘
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          STORAGE LAYER (internal/storage)                           │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Database                                          │  │
│  │                         (GORM-based ORM)                                       │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                            │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                         Focused Interfaces                                     │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │  │
│  │  │ Repository   │ │   Batch      │ │  Analytics   │ │  MigrationHistory    │   │  │
│  │  │   Store      │ │   Store      │ │    Store     │ │      Store           │   │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────────────┘   │  │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │  │
│  │  │  Dependency  │ │    User      │ │    Team      │ │       ADO            │   │  │
│  │  │    Store     │ │   Store      │ │   Store      │ │      Store           │   │  │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                            │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                           DialectDialer                                        │  │
│  │           (Portable SQL for SQLite, PostgreSQL, SQL Server)                    │  │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────────────┐   │  │
│  │  │  SQLiteDialect  │ │ PostgresDialect │ │       SQLServerDialect          │   │  │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
                              ┌─────────────────┐
                              │    Database     │
                              │ SQLite/Postgres │
                              │   SQL Server    │
                              └─────────────────┘
```

## External Integrations

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        EXTERNAL CLIENTS (internal/github, internal/azuredevops)     │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                          GitHub Client                                       │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐  │    │
│  │  │   REST API     │  │  GraphQL API   │  │        Rate Limiter            │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────────┘  │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐  │    │
│  │  │  Migrations    │  │     Teams      │  │       Organizations            │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────────┘  │    │
│  │  ┌────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                       DualClient                                        │  │    │
│  │  │            (Manages JWT/Installation token switching)                   │  │    │
│  │  └────────────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Azure DevOps Client                                     │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐  │    │
│  │  │  Repositories  │  │   Pipelines    │  │         Work Items             │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
            ┌───────────────────────────┴───────────────────────────┐
            │                                                       │
┌───────────────────────────┐                       ┌───────────────────────────┐
│  GitHub Enterprise Server │                       │      Azure DevOps         │
│  GitHub Enterprise Cloud  │                       │   (Projects, Repos,       │
│        github.com         │                       │   Pipelines, Boards)      │
└───────────────────────────┘                       └───────────────────────────┘
```

## Authentication & Authorization

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            AUTH LAYER (internal/auth)                               │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                         Authentication Flow                                  │    │
│  │                                                                              │    │
│  │    ┌─────────────┐      ┌─────────────┐      ┌─────────────────────────┐     │    │
│  │    │   GitHub    │ ──▶  │    OAuth    │ ──▶  │   Session/Token         │     │    │
│  │    │   OAuth     │      │  Callback   │      │     Storage             │     │    │
│  │    └─────────────┘      └─────────────┘      └─────────────────────────┘     │    │
│  │                                                                              │    │
│  │    ┌─────────────┐      ┌─────────────┐      ┌─────────────────────────┐     │    │
│  │    │   Entra ID  │ ──▶  │   OIDC      │ ──▶  │   JWT Validation        │     │    │
│  │    │   (Azure)   │      │  Callback   │      │                         │     │    │
│  │    └─────────────┘      └─────────────┘      └─────────────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                         Authorization                                        │    │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐   │    │
│  │  │    Authorizer    │  │ PermissionChecker│  │       Middleware         │   │    │
│  │  │  - Role checks   │  │  - Repo access   │  │  - Token validation      │   │    │
│  │  │  - Org admin     │  │  - Org membership│  │  - Context population    │   │    │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Data Models

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            MODELS (internal/models)                                 │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Repository                                         │    │
│  │                         (80+ fields)                                         │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐  │    │
│  │  │ GitProperties  │  │ GitHubFeatures │  │      SecurityFeatures          │  │    │
│  │  │ - Size, LFS    │  │ - Wiki, Pages  │  │  - CodeScanning, Dependabot    │  │    │
│  │  │ - Branches     │  │ - Actions      │  │  - SecretScanning              │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────────┘  │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐  │    │
│  │  │ MigrationState │  │ GHESLimits     │  │      ADOProperties             │  │    │
│  │  │ - Status       │  │ - Oversized    │  │  - Project, Pipelines          │  │    │
│  │  │ - Batch        │  │ - Blockers     │  │  - Work Items                  │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐     │
│  │    Batch     │  │  Migration   │  │  GitHubTeam  │  │     GitHubUser       │     │
│  │              │  │   History    │  │              │  │                      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐     │
│  │ UserMapping  │  │ TeamMapping  │  │  ADOProject  │  │ DiscoveryProgress    │     │
│  │              │  │              │  │              │  │                      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│   Client   │ ──▶ │   Router   │ ──▶ │ Middleware │ ──▶ │  Handler   │
│  Request   │     │            │     │  (Auth,    │     │            │
│            │     │            │     │  Logging)  │     │            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
                                                               │
                                                               ▼
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  Response  │ ◀── │  Handler   │ ◀── │  Service   │ ◀── │  Storage   │
│            │     │            │     │   Layer    │     │   Layer    │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

## Migration Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Migration Execution Flow                          │
│                                                                          │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌────────┐ │
│  │   Pre-   │──▶│ Archive  │──▶│  Queue   │──▶│ Migrate  │──▶│  Post- │ │
│  │Migration │   │ Generate │   │   for    │   │ Content  │   │Migrate │ │
│  └──────────┘   └──────────┘   │Migration │   └──────────┘   └────────┘ │
│       │              │         └──────────┘        │              │      │
│       ▼              ▼              │              ▼              ▼      │
│  ┌──────────┐   ┌──────────┐        │         ┌──────────┐   ┌────────┐ │
│  │ Lock     │   │ Create   │        │         │  Poll    │   │Validate│ │
│  │ Source   │   │ Archive  │        │         │ Progress │   │ Verify │ │
│  │ Repo     │   │  on      │        │         │          │   │        │ │
│  └──────────┘   │ Source   │        │         └──────────┘   └────────┘ │
│                 └──────────┘        │                                    │
│                                     ▼                                    │
│                              ┌──────────┐                               │
│                              │  Start   │                               │
│                              │Migration │                               │
│                              │  on GH   │                               │
│                              └──────────┘                               │
└──────────────────────────────────────────────────────────────────────────┘
```

## Package Dependencies

```
                                 ┌─────────┐
                                 │   cmd   │
                                 │ server  │
                                 └────┬────┘
                                      │
                                      ▼
                                 ┌─────────┐
                                 │   api   │
                                 │ server  │
                                 └────┬────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
             ┌──────────┐      ┌──────────┐      ┌──────────┐
             │ handlers │      │   auth   │      │middleware│
             └────┬─────┘      └──────────┘      └──────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌────────┐  ┌──────────┐  ┌──────────┐
│services│  │ discovery│  │ migration│
└───┬────┘  └────┬─────┘  └────┬─────┘
    │            │             │
    │       ┌────┴────┐        │
    │       │         │        │
    ▼       ▼         ▼        ▼
┌────────────────┐  ┌────────────────┐
│    storage     │  │     github     │
│                │  │   azuredevops  │
└───────┬────────┘  └────────────────┘
        │
        ▼
┌────────────────┐
│     models     │
│    config      │
│    logging     │
└────────────────┘
```

## Key Design Patterns

### 1. **Layered Architecture**
- Clear separation: API → Service → Storage
- Each layer has focused responsibilities
- Dependency injection for testability

### 2. **Interface Segregation**
- Focused interfaces (RepositoryStore, BatchStore, etc.)
- Composable DataStore interface
- Easy mocking for tests

### 3. **Strategy Pattern**
- Migration strategies for GitHub vs ADO
- Dialect strategies for SQL databases

### 4. **Component-Based Models**
- Repository fields grouped into logical components
- Getter/Setter methods for component access
- Prepared for future struct embedding

### 5. **Shared Utilities**
- HandlerUtils for common handler operations
- TeamMemberSaver for discovery operations
- Reduces code duplication

## Directory Structure

```
internal/
├── ado/              # Azure DevOps URL parsing utilities
├── api/              # HTTP API layer
│   ├── handlers/     # Domain-specific HTTP handlers
│   └── middleware/   # HTTP middleware (CORS, logging)
├── auth/             # Authentication & authorization
├── azuredevops/      # Azure DevOps API client
├── batch/            # Batch orchestration & scheduling
├── config/           # Configuration loading
├── discovery/        # Repository/team/member discovery
├── embedded/         # Embedded binaries (git-sizer)
├── github/           # GitHub API client (REST + GraphQL)
├── logging/          # Structured logging
├── migration/        # Migration execution & strategies
├── models/           # Data models & constants
├── services/         # Business logic layer
├── source/           # Source provider abstraction
├── storage/          # Database access layer
│   └── migrations/   # SQL migration files
└── worker/           # Background worker pool
```

