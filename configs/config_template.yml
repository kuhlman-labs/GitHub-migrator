# GitHub Migrator - Configuration Example
# This file documents all available configuration options
# 
# USAGE OPTIONS:
#   1. YAML Config: Copy this file to config.yaml and customize
#   2. Environment Variables: Use GHMIG_* prefixed env vars (see env.example)
#   3. .env File: Create a .env file in project root with GHMIG_* variables
#   4. Mixed: Combine YAML config with env var overrides
# 
# Notes:
#   - config.yaml is optional - defaults and env vars work without it
#   - .env files are automatically loaded for local development
#   - Environment variables override YAML values
#   - All files with credentials are gitignored

# =============================================================================
# Server Configuration
# =============================================================================
server:
  # HTTP server port (default: 8080)
  port: 8080

# =============================================================================
# Temporary Directory Configuration (Optional)
# =============================================================================
# Custom temporary directory for binary extraction and repository clones
# 
# Default behavior:
# - Standard environments: Uses system temp directory (os.TempDir())
# - Azure App Service: Automatically detects and uses /home/site/tmp
# - Custom override: Set GHMIG_TEMP_DIR environment variable
#
# Azure App Service Note:
# The application automatically detects Azure via WEBSITE_SITE_NAME environment
# variable and uses /home/site/tmp, which has proper permissions for binary
# extraction and execution. No configuration needed for Azure deployments.
#
# Only set this via environment variable if you need to override the default:
# GHMIG_TEMP_DIR=/custom/temp/path
#
# Example use cases for custom override:
# - Storage with more space for large repository clones
# - Specific security/compliance requirements
# - Non-standard container environments
#
# Note: This setting cannot be configured in YAML, only via environment variable

# =============================================================================
# Database Configuration
# =============================================================================
database:
  # Database type: "sqlite" or "postgres"
  # - sqlite: Recommended for development and small deployments
  # - postgres: Recommended for production
  type: sqlite
  
  # Database connection string (DSN)
  # SQLite example:
  dsn: ./data/migrator.db
  
  # PostgreSQL example:
  # dsn: postgres://user:password@localhost:5432/migrator?sslmode=disable
  
  # Or use environment variable:
  # dsn: "${DATABASE_URL}"

# =============================================================================
# Source Repository System Configuration
# =============================================================================
# This is where you're migrating FROM
source:
  # Source system type
  # Supported: 
  #   - "github" (full support - GitHub to GitHub migrations)
  #   - "azuredevops" (full support - Azure DevOps to GitHub migrations)
  # In development: "gitlab"
  type: github
  
  # API base URL
  # For GitHub Enterprise Server: https://github.company.com/api/v3
  # For GitHub.com: https://api.github.com
  # For Azure DevOps: https://dev.azure.com/your-organization
  base_url: "https://github.company.com/api/v3"
  
  # Personal Access Token (PAT) - REQUIRED
  # GitHub: Used for all migration operations
  #   - If GitHub App is configured, PAT is used for migrations only
  #   - Required scopes: repo, read:org, read:user, admin:org
  # Azure DevOps: Server-level PAT for executing migrations
  #   - Required scopes: Code (Read), Build (Read), Work Items (Read), 
  #     Project and Team (Read), Graph (Read)
  token: "ghp_xxxx"  # or Azure DevOps PAT
  
  # Azure DevOps specific configuration (only used when type is "azuredevops")
  # Organization name - REQUIRED for ADO
  # organization: "your-ado-org"
  
  # ==========================================================================
  # GitHub App Authentication (Optional but Recommended for Large Migrations)
  # ==========================================================================
  # Benefits:
  # - 5,000 requests/hour PER installation vs 5,000/hour total with PAT
  # - Better isolation with per-organization tokens
  # - Parallel organization processing for enterprise migrations
  # - Separation of concerns: App for discovery, PAT for migrations
  #
  # Two Operation Modes:
  #
  # MODE 1: With Installation ID (Simpler)
  #   Best for: Single org, testing, GitHub Apps installed on one organization
  #   Behavior: Uses that installation's token for all API operations
  #   
  #   app_id: 123456
  #   app_private_key: "/path/to/private-key.pem"  # or inline PEM string
  #   app_installation_id: 789012  # Provide for single-org mode
  #
  # MODE 2: Without Installation ID (Enterprise Multi-Org)
  #   Best for: GitHub Enterprise Apps, multi-org migrations
  #   Behavior: Auto-discovers all installations via JWT, creates per-org clients,
  #             processes organizations in parallel (5 workers by default)
  #   
  #   app_id: 123456
  #   app_private_key: "/path/to/private-key.pem"  # or inline PEM string
  #   # app_installation_id omitted - system auto-discovers
  #
  # Private Key Options:
  # 1. File path: "/path/to/private-key.pem"
  # 2. Inline PEM: "-----BEGIN RSA PRIVATE KEY-----\nMIIE...\n-----END RSA PRIVATE KEY-----"
  # 3. Environment variable: "${GHMIG_SOURCE_APP_PRIVATE_KEY}"
  #
  # See OPERATIONS.md for complete setup guide including:
  # - Creating GitHub Apps
  # - Configuring permissions
  # - Finding installation IDs
  # - Troubleshooting

# =============================================================================
# Destination Repository System Configuration
# =============================================================================
# This is where you're migrating TO
# Currently only GitHub is fully supported as a migration destination
destination:
  # Destination system type
  # Supported: "github" (full support)
  # Note: Only GitHub is supported as a destination for migrations
  type: github
  
  # API base URL
  # For GitHub with data residency: https://api.company.ghe.com
  # For GitHub Enterprise Cloud: https://api.github.com
  base_url: "https://api.github.com"
  
  # Personal Access Token (PAT) - REQUIRED
  # This token is REQUIRED for all migration operations
  # If GitHub App is configured, PAT is used for migrations only
  # Required permissions:
  # - Organization admin access (both source and destination)
  # - Scopes: repo, admin:org, workflow
  token: "ghp_yyyy"
  
  # ==========================================================================
  # GitHub App Authentication (Optional but Recommended for Large Migrations)
  # ==========================================================================
  # Same configuration options as source above.
  # Benefits:
  # - 15,000 requests/hour PER installation vs 5,000/hour total with PAT
  # - Better isolation with per-organization tokens
  # - Parallel organization processing for enterprise migrations
  # - Separation of concerns: App for discovery, PAT for migrations
  #
  # MODE 1: With Installation ID (Simpler)
  #   app_id: 123456
  #   app_private_key: "/path/to/private-key.pem"
  #   app_installation_id: 789012
  #
  # MODE 2: Without Installation ID (Enterprise Multi-Org)
  #   app_id: 123456
  #   app_private_key: "/path/to/private-key.pem"
  #   # app_installation_id omitted for auto-discovery
  #
  # See OPERATIONS.md for complete setup guide

# =============================================================================
# Migration Worker Configuration
# =============================================================================
migration:
  # Number of parallel migration workers
  # Higher values = faster migrations but more API rate limit usage
  # Recommended: 5-10 for most deployments
  # Default: 5
  workers: 5
  
  # Polling interval in seconds
  # How often workers check for new repositories to migrate
  # Default: 30
  poll_interval_seconds: 30
  
  # Post-migration validation mode
  # When to run validation after migration completes:
  # - "never": No validation
  # - "production_only": Validate only production migrations (recommended)
  # - "dry_run_only": Validate only dry runs
  # - "always": Validate all migrations
  # Default: "production_only"
  post_migration_mode: "production_only"
  
  # What to do if destination repository already exists
  # Options:
  # - "fail": Fail the migration (safest, recommended)
  # - "skip": Skip this repository and continue
  # - "delete": Delete the existing destination repo and recreate (dangerous!)
  # Default: "fail"
  dest_repo_exists_action: "fail"
  
  # Visibility transformation rules
  # Controls how repository visibility is mapped from source to destination
  # IMPORTANT: GitHub visibility controls who can read the repository:
  # - public: Anyone with the URL can read/clone
  # - internal: Anyone in the Enterprise can read/clone
  # - private: Only users with explicit access can read/write
  #
  # Note: EMU and data residency environments do NOT support public repositories
  visibility_handling:
    # How to handle public repositories
    # Options: "public", "internal", or "private"
    # Default: "private" (safest, works in all environments)
    # - "public": Keep as public (fails in EMU/data residency)
    # - "internal": Convert to internal (maintains enterprise-wide read access)
    # - "private": Convert to private (most restrictive)
    public_repos: "private"
    
    # How to handle internal repositories
    # Options: "internal" or "private"
    # Default: "private" (safest for GitHub.com migrations)
    # - "internal": Keep as internal (requires Enterprise Cloud)
    # - "private": Convert to private (works everywhere)
    internal_repos: "private"
    
    # Note: Private repositories always migrate as private

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  # Log level: "debug", "info", "warn", "error"
  # - debug: Verbose logging, includes all operations
  # - info: Standard logging (recommended for production)
  # - warn: Only warnings and errors
  # - error: Only errors
  # Default: "info"
  level: info
  
  # Log format: "json" or "text"
  # - json: Structured JSON logs (recommended for production)
  # - text: Human-readable format (good for development)
  # Default: "json"
  format: json
  
  # Log file path
  # Logs are rotated automatically based on settings below
  # Default: "./logs/migrator.log"
  output_file: ./logs/migrator.log
  
  # Maximum log file size in megabytes before rotation
  # Default: 100
  max_size: 100
  
  # Maximum number of old log files to retain
  # Default: 3
  max_backups: 3
  
  # Maximum number of days to retain old log files
  # Default: 28
  max_age: 28

# =============================================================================
# Authentication & Authorization (Optional)
# =============================================================================
# IMPORTANT: Authentication is DISABLED by default for backward compatibility
# Enable this for production deployments to control who can access the system
auth:
  # Enable/disable authentication
  # When disabled: Open access to all endpoints (default for dev/testing)
  # When enabled: Requires GitHub OAuth authentication
  # Default: false
  enabled: false
  
  # GitHub OAuth Application Configuration
  # Required when auth.enabled = true
  # Create an OAuth App at:
  # - GitHub.com: https://github.com/settings/developers
  # - GitHub Enterprise: https://your-ghes/settings/developers
  # github_oauth_client_id: "Iv1.abcd1234efgh5678"
  # github_oauth_client_secret: "your-oauth-client-secret-here"
  
  # GitHub OAuth Base URL (Optional)
  # Defaults to the source URL if source is GitHub, otherwise destination URL
  # Override this if OAuth should authenticate against a different GitHub instance
  # Examples:
  # - GitHub.com: "https://api.github.com"
  # - GHES: "https://github.company.com/api/v3"
  # github_oauth_base_url: "https://api.github.com"
  
  # OAuth callback URL
  # Must match the callback URL configured in your OAuth App
  # Format: https://your-migrator-domain.com/api/v1/auth/callback
  # callback_url: "https://migrator.company.com/api/v1/auth/callback"
  
  # Frontend URL to redirect to after successful login
  # In production with integrated frontend/backend: use "/" (same domain)
  # In development with separate ports: use "http://localhost:3000"
  # Default: "http://localhost:3000"
  # frontend_url: "/"
  
  # Session secret key for JWT signing
  # MUST be a strong random string (32+ characters)
  # Generate with: openssl rand -base64 32
  # IMPORTANT: Keep this secret and don't commit to version control!
  # session_secret: "your-random-secret-key-at-least-32-characters-long"
  
  # Session duration in hours
  # How long users stay logged in before re-authentication required
  # Default: 24 (1 day)
  # session_duration_hours: 24
  
  # Authorization Rules (Optional)
  # Control WHO can access the system after authentication
  # If no rules are specified, any authenticated GitHub user can access
  # authorization_rules:
    # Require user to be member of specific organizations
    # User must be a member of AT LEAST ONE of these organizations
    # Leave empty to not require org membership
    # require_org_membership:
    #   - "my-company-org"
    #   - "migration-team-org"
    
    # Require user to be member of specific teams
    # User must be a member of AT LEAST ONE of these teams
    # Format: "organization/team-slug"
    # Team slugs are lowercase with hyphens (e.g., "platform-team")
    # Leave empty to not require team membership
    # require_team_membership:
    #   - "my-company-org/migration-admins"
    #   - "my-company-org/platform-team"
    
    # Require user to be an Enterprise administrator
    # If true, only GitHub Enterprise admins can access the system
    # Requires require_enterprise_slug to be set
    # Default: false
    # require_enterprise_admin: false
    
    # Require user to be a member of the Enterprise (any role)
    # If true, any member of the enterprise can access the system
    # More permissive than require_enterprise_admin - allows all enterprise members
    # Repository-level permissions still apply to limit what they can migrate
    # Requires require_enterprise_slug to be set
    # Default: false
    # require_enterprise_membership: false
    
    # Enterprise slug for admin/membership verification
    # Required if require_enterprise_admin or require_enterprise_membership is true
    # This is the slug of your GitHub Enterprise
    # NOTE: If configured, enterprise admins automatically get FULL MIGRATION ACCESS
    #       (can migrate any repository), regardless of require_enterprise_admin setting
    # require_enterprise_slug: "my-enterprise"
    
    # Privileged teams (Full Migration Access)
    # Members of these teams have FULL ACCESS to migrate any repository
    # This bypasses per-repository permission checks
    # Use for migration admin teams that should have unrestricted access
    # Format: "organization/team-slug"
    # Team slugs are lowercase with hyphens
    # Leave empty to not grant any teams full access
    # privileged_teams:
    #   - "my-company-org/migration-admins"
    #   - "my-company-org/platform-engineering"
  
  # ==========================================================================
  # Azure DevOps Authentication (Entra ID OAuth)
  # ==========================================================================
  # When source type is "azuredevops", users can authenticate via Microsoft Entra ID
  # This provides user-level access control for ADO organizations and projects
  # The server-level ADO PAT (source.token) is used for migration execution
  
  # Enable Entra ID OAuth for Azure DevOps
  # Only used when source.type = "azuredevops"
  # Default: false
  # entraid_enabled: false
  
  # Microsoft Entra ID Tenant ID (Azure AD Directory ID)
  # Find this in Azure Portal → Azure Active Directory → Overview
  # Example: "12345678-1234-1234-1234-123456789012"
  # entraid_tenant_id: "your-tenant-id"
  
  # Entra ID Application (Client) ID
  # Create an App Registration in Azure Portal → Azure Active Directory
  # → App registrations → New registration
  # Example: "87654321-4321-4321-4321-210987654321"
  # entraid_client_id: "your-client-id"
  
  # Entra ID Application Client Secret
  # Generate in Azure Portal → App registrations → Your App → Certificates & secrets
  # IMPORTANT: Keep this secret and don't commit to version control!
  # entraid_client_secret: "your-client-secret"
  
  # Entra ID OAuth Callback URL
  # Must match the redirect URI configured in your Entra ID App Registration
  # Format: https://your-migrator-domain.com/api/v1/auth/entraid/callback
  # entraid_callback_url: "https://migrator.company.com/api/v1/auth/entraid/callback"
  
  # Azure DevOps Organization URL
  # Used to validate user access to the ADO organization
  # Format: https://dev.azure.com/your-organization
  # ado_organization_url: "https://dev.azure.com/your-ado-org"

# Example: Enabled authentication with org membership requirement
# auth:
#   enabled: true
#   github_oauth_client_id: "Iv1.abcd1234efgh5678"
#   github_oauth_client_secret: "${GITHUB_OAUTH_CLIENT_SECRET}"
#   callback_url: "https://migrator.company.com/api/v1/auth/callback"
#   session_secret: "${AUTH_SESSION_SECRET}"
#   session_duration_hours: 24
#   authorization_rules:
#     require_org_membership:
#       - "acme-corp"

# Example: Azure DevOps with Entra ID OAuth
# source:
#   type: azuredevops
#   base_url: "https://dev.azure.com/your-organization"
#   token: "${SOURCE_ADO_TOKEN}"  # Server-level ADO PAT
#   organization: "your-organization"
# 
# destination:
#   type: github
#   base_url: "https://api.github.com"
#   token: "${DEST_GITHUB_TOKEN}"
# 
# auth:
#   enabled: true
#   entraid_enabled: true
#   entraid_tenant_id: "${ENTRAID_TENANT_ID}"
#   entraid_client_id: "${ENTRAID_CLIENT_ID}"
#   entraid_client_secret: "${ENTRAID_CLIENT_SECRET}"
#   entraid_callback_url: "https://migrator.company.com/api/v1/auth/entraid/callback"
#   ado_organization_url: "https://dev.azure.com/your-organization"
#   session_secret: "${AUTH_SESSION_SECRET}"
#   session_duration_hours: 24

# Example: Team-based access control
# auth:
#   enabled: true
#   github_oauth_client_id: "Iv1.abcd1234efgh5678"
#   github_oauth_client_secret: "${GITHUB_OAUTH_CLIENT_SECRET}"
#   callback_url: "https://migrator.company.com/api/v1/auth/callback"
#   session_secret: "${AUTH_SESSION_SECRET}"
#   session_duration_hours: 24
#   authorization_rules:
#     require_team_membership:
#       - "acme-corp/migration-team"
#       - "acme-corp/platform-engineering"

# Example: Enterprise admin only access
# auth:
#   enabled: true
#   github_oauth_client_id: "Iv1.abcd1234efgh5678"
#   github_oauth_client_secret: "${GITHUB_OAUTH_CLIENT_SECRET}"
#   callback_url: "https://migrator.company.com/api/v1/auth/callback"
#   session_secret: "${AUTH_SESSION_SECRET}"
#   session_duration_hours: 24
#   authorization_rules:
#     require_enterprise_admin: true
#     require_enterprise_slug: "acme-enterprise"

# Example: Enterprise membership with repository-level permissions
# auth:
#   enabled: true
#   github_oauth_client_id: "Iv1.abcd1234efgh5678"
#   github_oauth_client_secret: "${GITHUB_OAUTH_CLIENT_SECRET}"
#   callback_url: "https://migrator.company.com/api/v1/auth/callback"
#   session_secret: "${AUTH_SESSION_SECRET}"
#   session_duration_hours: 24
#   authorization_rules:
#     require_enterprise_membership: true
#     require_enterprise_slug: "acme-enterprise"
#     # Users can only migrate repos they have admin access to
#     # Unless they're in a privileged team:
#     privileged_teams:
#       - "acme-corp/migration-admins"

# =============================================================================
# Legacy GitHub Configuration (Deprecated)
# =============================================================================
# This section is maintained for backward compatibility only
# New deployments should use the source/destination format above

# github:
#   source:
#     base_url: "https://github.company.com/api/v3"
#     token: "ghp_xxxx"
#   
#   destination:
#     base_url: "https://api.github.com"
#     token: "ghp_yyyy"

# =============================================================================
# Environment Variable Overrides
# =============================================================================
# All configuration values can be overridden with environment variables
# using the GHMIG_ prefix and uppercase keys with underscores
#
# Examples:
#   GHMIG_SERVER_PORT=8080
#   GHMIG_DATABASE_TYPE=postgres
#   GHMIG_DATABASE_DSN=postgres://...
#   GHMIG_SOURCE_TYPE=github
#   GHMIG_SOURCE_BASE_URL=https://...
#   GHMIG_SOURCE_TOKEN=ghp_...
#   GHMIG_DESTINATION_TYPE=github
#   GHMIG_DESTINATION_BASE_URL=https://...
#   GHMIG_DESTINATION_TOKEN=ghp_...
#   GHMIG_MIGRATION_WORKERS=10
#   GHMIG_MIGRATION_POLL_INTERVAL_SECONDS=30
#   GHMIG_MIGRATION_POST_MIGRATION_MODE=production_only
#   GHMIG_MIGRATION_DEST_REPO_EXISTS_ACTION=fail
#   GHMIG_LOGGING_LEVEL=info
#   GHMIG_LOGGING_FORMAT=json
#   GHMIG_LOGGING_OUTPUT_FILE=./logs/migrator.log
#   GHMIG_LOGGING_MAX_SIZE=100
#   GHMIG_LOGGING_MAX_BACKUPS=3
#   GHMIG_LOGGING_MAX_AGE=28
#   GHMIG_TEMP_DIR=/custom/temp/path
#
# See configs/env.example for a complete list of environment variables

# =============================================================================
# Notes
# =============================================================================
# 1. SUPPORTED MIGRATIONS:
#    - Currently only GitHub-to-GitHub migrations are fully supported
#    - Source: GitHub.com or GitHub Enterprise Server
#    - Destination: GitHub.com, GitHub with data residency, or GHEC EMU
#    - Note: GitLab and Azure DevOps support is planned but not yet implemented
#
# 2. AUTHENTICATION:
#    - PAT (Personal Access Token) is REQUIRED for migrations
#    - GitHub App authentication is OPTIONAL for discovery/profiling
#    - When both are configured: GitHub App used for discovery, PAT used for migrations
#    - Tokens MUST have organization admin access on both source and destination
#
# 3. DESTINATION ORGANIZATIONS:
#    - The destination organization for each repository can be customized per-repo
#      via the API or web interface (defaults to source organization name)
#
# 4. AUTHENTICATION (OPTIONAL):
#    - Authentication is DISABLED by default for backward compatibility
#    - Enable for production to control access via GitHub OAuth
#    - Supports org membership, team membership, or enterprise admin requirements
#    - See OPERATIONS.md for OAuth App setup instructions
#
# 5. SECURITY:
#    - Sensitive values (tokens, passwords, secrets) should use environment variables
#      rather than being stored in this file
#    - Never commit OAuth client secrets or session secrets to version control
#    - Use strong random strings for session_secret (32+ characters)
#
# 6. PRODUCTION:
#    - Use PostgreSQL instead of SQLite for production deployments
#    - Enable authentication with appropriate authorization rules
#    - Log rotation happens automatically - no need to configure logrotate

