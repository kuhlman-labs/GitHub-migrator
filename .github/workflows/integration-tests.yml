name: Database Integration Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'internal/storage/**'
      - 'internal/models/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'internal/storage/**'
      - 'internal/models/**'
      - 'go.mod'
      - 'go.sum'
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test-sqlserver:
        description: 'Run SQL Server tests (takes longer)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # Always run: SQLite (fastest, no dependencies)
  test-sqlite:
    name: Integration Tests - SQLite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run SQLite integration tests
        run: go test -tags=integration -v ./internal/storage -run TestIntegrationSQLite -timeout 2m
        env:
          CGO_ENABLED: 1

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-test-results
          path: |
            coverage.out
            test-results.json
          retention-days: 7

  # Run on main, develop, and PRs: PostgreSQL (production database)
  test-postgresql:
    name: Integration Tests - PostgreSQL
    runs-on: ubuntu-latest
    
    # Use GitHub Actions service container for PostgreSQL
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: migrator_test
          POSTGRES_USER: migrator
          POSTGRES_PASSWORD: test_password_123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U migrator; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

      - name: Run PostgreSQL integration tests
        run: go test -tags=integration -v ./internal/storage -run TestIntegrationPostgreSQL -timeout 5m
        env:
          CGO_ENABLED: 1
          POSTGRES_TEST_DSN: "postgres://migrator:test_password_123@localhost:5432/migrator_test?sslmode=disable"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-test-results
          path: |
            coverage.out
            test-results.json
          retention-days: 7

  # Optional: SQL Server (expensive, run on schedule or manual trigger)
  test-sqlserver:
    name: Integration Tests - SQL Server
    runs-on: ubuntu-latest
    # Only run on:
    # 1. Scheduled runs (daily)
    # 2. Manual workflow dispatch with checkbox
    # 3. Changes to main branch (optional)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.test-sqlserver == true) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    # SQL Server container requires more resources
    # Note: This uses Docker-in-Docker which can be slower
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Start SQL Server container
        run: |
          docker run -d \
            --name sqlserver \
            -e "ACCEPT_EULA=Y" \
            -e "SA_PASSWORD=YourStrong@Passw0rd" \
            -e "MSSQL_PID=Developer" \
            -p 1433:1433 \
            mcr.microsoft.com/mssql/server:2022-latest

      - name: Wait for SQL Server to be ready
        run: |
          echo "Waiting for SQL Server to start..."
          for i in {1..60}; do
            if docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -Q "SELECT 1" > /dev/null 2>&1; then
              echo "SQL Server is ready!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "SQL Server failed to start within 60 seconds"
              exit 1
            fi
            sleep 2
          done

      - name: Create test database
        run: |
          docker exec sqlserver /opt/mssql-tools/bin/sqlcmd \
            -S localhost -U sa -P "YourStrong@Passw0rd" \
            -Q "CREATE DATABASE migrator_test;"

      - name: Run SQL Server integration tests
        run: go test -tags=integration -v ./internal/storage -run TestIntegrationSQLServer -timeout 5m
        env:
          CGO_ENABLED: 1
          SQLSERVER_TEST_DSN: "sqlserver://sa:YourStrong@Passw0rd@localhost:1433?database=migrator_test"

      - name: Stop SQL Server container
        if: always()
        run: docker stop sqlserver && docker rm sqlserver

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sqlserver-test-results
          path: |
            coverage.out
            test-results.json
          retention-days: 7

  # Summary and reporting
  integration-test-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-sqlite, test-postgresql, test-sqlserver]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## üß™ Database Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Database | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # SQLite
          if [[ "${{ needs.test-sqlite.result }}" == "success" ]]; then
            echo "| SQLite | ‚úÖ Passed | Fast, always tested |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SQLite | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PostgreSQL
          if [[ "${{ needs.test-postgresql.result }}" == "success" ]]; then
            echo "| PostgreSQL | ‚úÖ Passed | Production database |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-postgresql.result }}" == "skipped" ]]; then
            echo "| PostgreSQL | ‚è≠Ô∏è Skipped | Not triggered |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PostgreSQL | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SQL Server
          if [[ "${{ needs.test-sqlserver.result }}" == "success" ]]; then
            echo "| SQL Server | ‚úÖ Passed | Enterprise database |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-sqlserver.result }}" == "skipped" ]]; then
            echo "| SQL Server | ‚è≠Ô∏è Skipped | Only on schedule/manual |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SQL Server | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.test-sqlite.result }}" == "success" ]] && \
             [[ "${{ needs.test-postgresql.result }}" == "success" ]] && \
             ([[ "${{ needs.test-sqlserver.result }}" == "success" ]] || [[ "${{ needs.test-sqlserver.result }}" == "skipped" ]]); then
            echo "### ‚úÖ All integration tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Some integration tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test logs and fix any failing tests." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test execution info
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Check critical failures
        run: |
          # Fail the job if SQLite or PostgreSQL tests fail (these are critical)
          if [[ "${{ needs.test-sqlite.result }}" == "failure" ]] || \
             [[ "${{ needs.test-postgresql.result }}" == "failure" ]]; then
            echo "‚ùå Critical database tests failed"
            exit 1
          fi
          
          # SQL Server is optional, so we don't fail on its failure
          echo "‚úÖ Critical tests passed"

