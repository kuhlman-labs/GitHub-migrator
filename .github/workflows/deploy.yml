name: Deploy to Slot

on:
  workflow_call:
    inputs:
      slot_name:
        description: 'Deployment slot name (dev, staging, or pr-{number})'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
      swap_to_production:
        description: 'Whether to swap the slot to production after deployment'
        required: false
        type: boolean
        default: false
    outputs:
      slot_url:
        description: 'URL of the deployed slot'
        value: ${{ jobs.deploy.outputs.slot_url }}

permissions:
  contents: read
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.slot_name }} slot
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.slot_name == 'staging' && 'prod' || inputs.slot_name }}
      url: ${{ steps.get-url.outputs.url }}
    outputs:
      slot_url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Deploy to slot
        id: deploy
        run: |
          APP_NAME="${{ vars.APP_SERVICE_NAME }}"
          SLOT_NAME="${{ inputs.slot_name }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ inputs.image_tag }}"

          echo "Deploying $IMAGE to slot $SLOT_NAME..."

          # Update the container image for the slot
          az webapp config container set \
            --name "$APP_NAME" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --slot "$SLOT_NAME" \
            --container-image-name "$IMAGE" \
            --container-registry-url "https://${{ env.REGISTRY }}"

          echo "Restarting slot..."
          az webapp restart \
            --name "$APP_NAME" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --slot "$SLOT_NAME"

      - name: Get slot URL
        id: get-url
        run: |
          APP_NAME="${{ vars.APP_SERVICE_NAME }}"
          SLOT_NAME="${{ inputs.slot_name }}"

          # Get the slot hostname
          HOSTNAME=$(az webapp deployment slot list \
            --name "$APP_NAME" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --query "[?name=='$SLOT_NAME'].defaultHostName" \
            --output tsv)

          URL="https://${HOSTNAME}"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "Slot URL: ${URL}"

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health check
        run: |
          SLOT_URL="${{ steps.get-url.outputs.url }}"
          echo "Checking health endpoint: ${SLOT_URL}/health"

          for i in {1..12}; do
            if curl -f -s "${SLOT_URL}/health" > /dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for app to be ready... (attempt $i/12)"
            sleep 10
          done

          echo "Health check failed after 12 attempts"
          exit 1

      - name: Swap to production
        if: inputs.swap_to_production
        run: |
          APP_NAME="${{ vars.APP_SERVICE_NAME }}"
          SLOT_NAME="${{ inputs.slot_name }}"

          echo "Swapping $SLOT_NAME slot to production..."
          az webapp deployment slot swap \
            --name "$APP_NAME" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --slot "$SLOT_NAME" \
            --target-slot production

          echo "Swap completed successfully!"

      - name: Deployment summary
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ inputs.image_tag }}"
          {
            echo "## Deployment Summary"
            echo ""
            echo "**Slot:** ${{ inputs.slot_name }}"
            echo "**URL:** ${{ steps.get-url.outputs.url }}"
            echo "**Image:** $IMAGE"
            echo "**Commit:** ${{ github.sha }}"
          } >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ inputs.swap_to_production }}" == "true" ]; then
            {
              echo ""
              echo "**Swapped to production**"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Logout from Azure
        run: az logout
        if: always()
